# 医院层级扫查系统使用指南

## 🚀 快速开始

### 1. 服务启动
服务已在 **http://localhost:8002** 启动运行

### 2. API 文档
- **Swagger UI**: http://localhost:8002/docs
- **ReDoc**: http://localhost:8002/redoc

## 📋 核心功能使用

### 🔍 1. 数据查询功能

#### 获取省份列表
```bash
curl http://localhost:8002/provinces
```

**响应示例:**
```json
{
  "items": [
    {
      "id": 1,
      "name": "北京市",
      "code": "110000",
      "cities_count": 0,
      "hospitals_count": 0,
      "created_at": "2025-11-21T16:12:41.116967",
      "updated_at": "2025-11-21T16:12:41.116967"
    }
  ],
  "total": 1,
  "page": 1,
  "page_size": 20,
  "pages": 1
}
```

#### 获取城市列表
```bash
# 需要指定省份参数（根据实际API调整）
curl http://localhost:8002/cities?province=北京市
```

#### 获取区县列表
```bash
curl http://localhost:8002/districts?city=北京市
```

#### 获取医院列表
```bash
curl http://localhost:8002/hospitals?district=朝阳区
```

#### 搜索医院
```bash
curl -G "http://localhost:8002/hospitals/search" --data-urlencode "q=协和"
```

### 🔄 2. 数据刷新功能

#### 全量数据刷新
```bash
curl -X POST http://localhost:8002/refresh/all
```

**响应示例:**
```json
{
  "task_id": "e29e231d-bb78-44a6-a789-19b6a450d2bc",
  "message": "全量刷新任务已启动，正在执行中...",
  "created_at": "2025-11-21T16:56:23.809722"
}
```

#### 指定省份刷新
```bash
curl -X POST http://localhost:8002/refresh/province/广东省
```

### 📊 3. 任务管理功能

#### 查看任务状态
```bash
curl http://localhost:8002/task/{task_id}
```

#### 查看所有任务
```bash
curl http://localhost:8002/tasks
```

**任务状态说明:**
- `pending`: 等待执行
- `running`: 正在执行
- `completed`: 执行完成
- `failed`: 执行失败

### 🔬 4. 医院扫描功能

#### 扫描指定医院
```bash
curl -X POST http://localhost:8002/scan \
  -H "Content-Type: application/json" \
  -d '{
    "hospital_name": "北京协和医院",
    "query": "获取医院层级结构和详细信息"
  }'
```

## 🛠️ 完整使用流程

### 步骤 1: 查看现有数据
```bash
# 1. 查看所有省份
curl http://localhost:8002/provinces

# 2. 查看某个省份的城市
curl http://localhost:8002/cities?province=北京市

# 3. 查看某个城市的区县
curl http://localhost:8002/districts?city=北京市

# 4. 查看某个区县的医院
curl http://localhost:8002/hospitals?district=朝阳区
```

### 步骤 2: 刷新数据（如需要）
```bash
# 启动全量刷新
curl -X POST http://localhost:8002/refresh/all

# 记录返回的 task_id
TASK_ID="e29e231d-bb78-44a6-a789-19b6a450d2bc"

# 查看刷新进度
curl http://localhost:8002/task/$TASK_ID
```

### 步骤 3: 搜索特定医院
```bash
# 搜索医院
curl -G "http://localhost:8002/hospitals/search" --data-urlencode "q=协和医院"

# 扫描特定医院获取详细信息
curl -X POST http://localhost:8002/scan \
  -H "Content-Type: application/json" \
  -d '{
    "hospital_name": "北京协和医院",
    "query": "获取科室信息和床位数"
  }'
```

## 📝 注意事项

### 1. API 密钥配置
为了使用完整的 LLM 功能，需要在 `.env` 文件中配置：
```bash
DASHSCOPE_API_KEY=your-dashscope-api-key-here
```

### 2. 数据限制
- 默认分页大小：20条记录
- 搜索返回限制：20条结果
- 并发任务限制：5个

### 3. 任务监控
- 任务执行可能需要较长时间（特别是全量刷新）
- 建议使用任务 ID 进行异步监控
- 可以查看所有任务列表了解系统状态

## 🔧 故障排除

### 1. 服务无响应
```bash
# 检查服务状态
curl http://localhost:8002/health

# 查看服务日志
tail -f logs/scanner.log
```

### 2. 任务执行失败
- 检查 API 密钥是否正确配置
- 查看任务错误信息
- 检查网络连接

### 3. 数据查询为空
- 可能需要先执行数据刷新
- 检查查询参数是否正确
- 确认数据库中是否有相关数据

## 🎯 最佳实践

### 1. 数据更新策略
- 定期执行全量刷新保持数据新鲜度
- 针对特定省份进行增量更新
- 监控任务执行状态和结果

### 2. 性能优化
- 使用分页查询避免大数据量加载
- 合理使用搜索功能定位目标医院
- 避免频繁的全量刷新操作

### 3. 错误处理
- 监控任务执行状态
- 处理 API 调用失败情况
- 记录和分析错误日志

## 📚 更多信息

- **技术文档**: 查看 `CLAUDE.md` 文件
- **API 参考**: 访问 http://localhost:8002/docs
- **测试用例**: 参考 `tests/` 目录下的测试文件

---

**提示**: 系统当前使用模拟数据模式，如需使用真实的阿里百炼 LLM 功能，请配置有效的 `DASHSCOPE_API_KEY`。