# åŒ»é™¢æ‰«æçŠ¶æ€ç›‘æ§æŒ‡å—

## ğŸ” æ‰«æçŠ¶æ€åˆ¤æ–­æ–¹æ³•

### 1. ä»»åŠ¡çŠ¶æ€ç±»å‹

æ ¹æ®ç³»ç»Ÿè®¾è®¡ï¼Œæ‰«æä»»åŠ¡æœ‰ä»¥ä¸‹çŠ¶æ€ï¼š

| çŠ¶æ€ | è¯´æ˜ | å«ä¹‰ |
|------|------|------|
| `pending` | â³ ç­‰å¾…ä¸­ | ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…æ‰§è¡Œ |
| `running` | ğŸ”„ è¿è¡Œä¸­ | ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼ŒLLMåˆ†æè¿›è¡Œä¸­ |
| `completed` | âœ… å·²å®Œæˆ | æ‰«ææˆåŠŸï¼Œç»“æœå¯ç”¨ |
| `failed` | âŒ å¤±è´¥ | æ‰«æå¤±è´¥ï¼Œæœ‰é”™è¯¯ä¿¡æ¯ |
| `cancelled` | â¹ï¸ å·²å–æ¶ˆ | ä»»åŠ¡è¢«ç”¨æˆ·å–æ¶ˆ |

### 2. åˆ¤æ–­æ‰«ææ˜¯å¦å®Œæˆ

#### æ–¹æ³•ä¸€ï¼šæ£€æŸ¥ä»»åŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹ç‰¹å®šä»»åŠ¡çŠ¶æ€
curl http://localhost:8002/task/{task_id}

# å“åº”ç¤ºä¾‹ - å·²å®Œæˆ
{
  "task_id": "10beaa46-1207-4b36-9e77-d59b14ee6545",
  "status": "completed",
  "result": "{...}",  # æœ‰ç»“æœæ•°æ®
  "error_message": null
}

# å“åº”ç¤ºä¾‹ - è¿è¡Œä¸­
{
  "task_id": "xxx",
  "status": "running",
  "result": null,
  "error_message": null
}
```

#### æ–¹æ³•äºŒï¼šæ£€æŸ¥ç»“æœå­—æ®µ
```bash
# è§£æä»»åŠ¡å“åº”ï¼Œåˆ¤æ–­æ˜¯å¦å®Œæˆ
is_completed = task["status"] == "completed"
has_result = task["result"] is not null
has_error = task["error_message"] is not null
```

### 3. è·å–æ‰«æç»“æœ

#### æˆåŠŸå®Œæˆçš„ä»»åŠ¡
å½“ä»»åŠ¡çŠ¶æ€ä¸º `completed` æ—¶ï¼Œ`result` å­—æ®µåŒ…å«å®Œæ•´çš„æ‰«æç»“æœï¼š

```json
{
  "task_id": "10beaa46-1207-4b36-9e77-d59b14ee6545",
  "status": "completed",
  "result": {
    "task_id": "10beaa46-1207-4b36-9e77-d59b14ee6545",
    "status": "completed",
    "hospital_info": {
      "hospital_name": "åŒ—äº¬åå’ŒåŒ»é™¢",
      "level": "ä¸‰çº§ç”²ç­‰",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºå¸…åºœå›­1å·",
      "phone": "010-69156114",
      "departments": [
        "å†…ç§‘", "å¤–ç§‘", "å¦‡äº§ç§‘", "å„¿ç§‘",
        "æ€¥è¯Šç§‘", "éª¨ç§‘", "ç¥ç»å†…ç§‘",
        "å¿ƒè¡€ç®¡å†…ç§‘", "è‚¿ç˜¤ç§‘", "ä¸­åŒ»ç§‘"
      ],
      "beds_count": 2000,
      "staff_count": 4000,
      "specializations": [
        "å¿ƒè¡€ç®¡ç–¾ç—…æ²»ç–—", "è‚¿ç˜¤ç»¼åˆæ²»ç–—",
        "ç¥ç»ç³»ç»Ÿç–¾ç—…", "éª¨ç§‘åˆ›ä¼¤æ²»ç–—"
      ],
      "management_structure": {
        "é™¢é•¿": 1, "å‰¯é™¢é•¿": 4,
        "ç§‘å®¤ä¸»ä»»": 25, "ç§‘å®¤å‰¯ä¸»ä»»": 40,
        "æŠ¤å£«é•¿": 60
      },
      "operating_hours": "24å°æ—¶æ€¥è¯Šï¼Œé—¨è¯Šæ—¶é—´ï¼š8:00-17:00",
      "website": "www.pumch.cn"
    },
    "created_at": "2025-11-21 17:32:09",
    "completed_at": "2025-11-21 17:32:15"
  }
}
```

#### å¤±è´¥çš„ä»»åŠ¡
å½“ä»»åŠ¡çŠ¶æ€ä¸º `failed` æ—¶ï¼Œ`error_message` å­—æ®µåŒ…å«é”™è¯¯ä¿¡æ¯ï¼š

```json
{
  "task_id": "xxx",
  "status": "failed",
  "result": null,
  "error_message": "LLM APIè°ƒç”¨å¤±è´¥: ç½‘ç»œè¶…æ—¶"
}
```

## ğŸš€ å®Œæ•´ä½¿ç”¨æµç¨‹

### 1. å¯åŠ¨æ‰«æ
```bash
curl -X POST http://localhost:8002/scan \
  -H "Content-Type: application/json" \
  -d '{
    "hospital_name": "åŒ—äº¬åå’ŒåŒ»é™¢",
    "query": "è·å–åŒ»é™¢å±‚çº§ç»“æ„å’Œè¯¦ç»†ä¿¡æ¯"
  }'
```

**å“åº”ï¼š**
```json
{
  "task_id": "10beaa46-1207-4b36-9e77-d59b14ee6545",
  "message": "æ‰«æä»»åŠ¡å·²åˆ›å»º",
  "status": "pending"
}
```

### 2. ç›‘æ§æ‰«æè¿›åº¦
```bash
# æ–¹æ³•ä¸€ï¼šè½®è¯¢æ£€æŸ¥
task_id="10beaa46-1207-4b36-9e77-d59b14ee6545"
while true; do
  response=$(curl -s http://localhost:8002/task/$task_id)
  status=$(echo $response | python -c "import sys, json; print(json.load(sys.stdin)['status'])")

  echo "å½“å‰çŠ¶æ€: $status"

  if [ "$status" = "completed" ] || [ "$status" = "failed" ]; then
    break
  fi

  sleep 3
done

# æ–¹æ³•äºŒï¼šä¸€æ¬¡æ€§æ£€æŸ¥
curl -s http://localhost:8002/task/$task_id | python -c "
import sys, json
task = json.load(sys.stdin)

print(f'ä»»åŠ¡çŠ¶æ€: {task[\"status\"]}')
print(f'åŒ»é™¢åç§°: {task[\"hospital_name\"]}')

if task['status'] == 'completed':
    print('âœ… æ‰«æå®Œæˆ')
    if task['result']:
        result = json.loads(task['result'])
        hospital_info = result['hospital_info']
        print(f'åŒ»é™¢ç­‰çº§: {hospital_info[\"level\"]}')
        print(f'åºŠä½æ•°: {hospital_info[\"beds_count\"]}')
        print(f'ç§‘å®¤æ•°é‡: {len(hospital_info[\"departments\"])}')
elif task['status'] == 'failed':
    print(f'âŒ æ‰«æå¤±è´¥: {task[\"error_message\"]}')
elif task['status'] == 'running':
    print('ğŸ”„ æ‰«æè¿›è¡Œä¸­...')
else:
    print('â³ ç­‰å¾…å¼€å§‹...')
"
```

### 3. è·å–å®Œæ•´ç»“æœ
```bash
# è·å–å®Œæ•´ç»“æœå¹¶æ ¼å¼åŒ–
curl -s http://localhost:8002/task/$task_id | python -c "
import sys, json
task = json.load(sys.stdin)

if task['status'] == 'completed' and task['result']:
    result = json.loads(task['result'])
    print('=== æ‰«æç»“æœè¯¦æƒ… ===')
    print(json.dumps(result, ensure_ascii=False, indent=2))
else:
    print('ä»»åŠ¡æœªå®Œæˆæˆ–æ— ç»“æœ')
"
```

## ğŸ“Š æ‰¹é‡ä»»åŠ¡ç®¡ç†

### æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
```bash
curl -s http://localhost:8002/tasks | python -c "
import sys, json
tasks = json.load(sys.stdin)

print(f'æ€»ä»»åŠ¡æ•°: {len(tasks)}')

# æŒ‰çŠ¶æ€åˆ†ç»„
status_count = {}
for task in tasks:
    status = task['status']
    status_count[status] = status_count.get(status, 0) + 1

print('\\nä»»åŠ¡çŠ¶æ€ç»Ÿè®¡:')
for status, count in status_count.items():
    emoji = 'âœ…' if status == 'completed' else 'âŒ' if status == 'failed' else 'ğŸ”„' if status == 'running' else 'â³'
    print(f'  {emoji} {status}: {count}')

# æ˜¾ç¤ºå·²å®Œæˆä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
print('\\nå·²å®Œæˆä»»åŠ¡:')
for task in tasks:
    if task['status'] == 'completed':
        print(f'  - {task[\"hospital_name\"]} (ID: {task[\"task_id\"][:8]}...)')
"
```

## ğŸ”§ å¼€å‘è€…é›†æˆ

### Python ç›‘æ§ç¤ºä¾‹
```python
import requests
import json
import time

class ScanMonitor:
    def __init__(self, base_url="http://localhost:8002"):
        self.base_url = base_url

    def start_scan(self, hospital_name, query=""):
        """å¯åŠ¨æ‰«æ"""
        response = requests.post(f"{self.base_url}/scan", json={
            "hospital_name": hospital_name,
            "query": query
        })
        return response.json()

    def wait_for_completion(self, task_id, timeout=300, interval=3):
        """ç­‰å¾…æ‰«æå®Œæˆ"""
        start_time = time.time()

        while time.time() - start_time < timeout:
            task = self.get_task(task_id)

            if task['status'] in ['completed', 'failed']:
                return task

            time.sleep(interval)

        raise TimeoutError(f"Task {task_id} did not complete within {timeout} seconds")

    def get_task(self, task_id):
        """è·å–ä»»åŠ¡çŠ¶æ€"""
        response = requests.get(f"{self.base_url}/task/{task_id}")
        return response.json()

    def get_scan_result(self, task_id):
        """è·å–æ‰«æç»“æœ"""
        task = self.wait_for_completion(task_id)

        if task['status'] == 'completed' and task['result']:
            return json.loads(task['result'])
        else:
            raise Exception(f"Scan failed: {task.get('error_message', 'Unknown error')}")

# ä½¿ç”¨ç¤ºä¾‹
monitor = ScanMonitor()

# å¯åŠ¨æ‰«æ
result = monitor.start_scan("åŒ—äº¬åå’ŒåŒ»é™¢", "è·å–å®Œæ•´åŒ»é™¢ä¿¡æ¯")
task_id = result['task_id']
print(f"æ‰«æå·²å¯åŠ¨ï¼Œä»»åŠ¡ID: {task_id}")

# ç­‰å¾…å®Œæˆå¹¶è·å–ç»“æœ
try:
    scan_result = monitor.get_scan_result(task_id)
    hospital_info = scan_result['hospital_info']

    print(f"æ‰«æå®Œæˆï¼")
    print(f"åŒ»é™¢åç§°: {hospital_info['hospital_name']}")
    print(f"åŒ»é™¢ç­‰çº§: {hospital_info['level']}")
    print(f"åºŠä½æ•°: {hospital_info['beds_count']}")

except Exception as e:
    print(f"æ‰«æå¤±è´¥: {e}")
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼‚æ­¥å¤„ç†
- æ‰«ææ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œä¸è¦åœ¨å‰ç«¯åŒæ­¥ç­‰å¾…
- ä½¿ç”¨ä»»åŠ¡IDè¿›è¡ŒçŠ¶æ€è½®è¯¢æˆ–Webhooké€šçŸ¥

### 2. é”™è¯¯å¤„ç†
- å§‹ç»ˆæ£€æŸ¥ `error_message` å­—æ®µ
- å®ç°é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶æ•…éšœ
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

### 3. ç»“æœç¼“å­˜
- å¯¹äºç›¸åŒåŒ»é™¢çš„æ‰«æï¼Œè€ƒè™‘ç¼“å­˜ç»“æœ
- é¿å…é‡å¤è°ƒç”¨LLM API

### 4. çŠ¶æ€ç›‘æ§
- å®šæœŸæ¸…ç†è¿‡æœŸçš„ä»»åŠ¡è®°å½•
- ç›‘æ§ä»»åŠ¡æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡
- å®ç°ä»»åŠ¡è¿›åº¦æŠ¥å‘Š

---

**æç¤º**: æ‰«æå®Œæˆçš„ä¸»è¦æ ‡å¿—æ˜¯ä»»åŠ¡çŠ¶æ€ä¸º `completed` ä¸” `result` å­—æ®µåŒ…å«æœ‰æ•ˆæ•°æ®ã€‚