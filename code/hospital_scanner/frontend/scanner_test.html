<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é™¢å±‚çº§æ‰«æç³»ç»Ÿæµ‹è¯•ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .scan-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
        }

        .status-card.pending {
            border-left-color: #ffc107;
        }

        .status-card.running {
            border-left-color: #17a2b8;
        }

        .status-card.failed {
            border-left-color: #dc3545;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .result-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .result-header h2 {
            color: #d63031;
            margin-bottom: 10px;
        }

        .hospital-info {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }

        .info-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #666;
            font-size: 14px;
        }

        .departments-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .departments-list h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: #007bff;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        .tag.specialization {
            background: #28a745;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin: 15px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .log-section {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.info {
            background: rgba(59, 130, 246, 0.1);
        }

        .log-entry.success {
            background: rgba(34, 197, 94, 0.1);
        }

        .log-entry.error {
            background: rgba(239, 68, 68, 0.1);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ åŒ»é™¢å±‚çº§æ‰«æç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½åŒ»é™¢ä¿¡æ¯åˆ†æä¸å±‚çº§ç»“æ„æ‰«ææµ‹è¯•å¹³å°</p>
        </div>

        <div class="main-content">
            <!-- æ‰«æè¡¨å• -->
            <div class="scan-form">
                <h3>ğŸ” å¯åŠ¨æ–°çš„æ‰«æä»»åŠ¡</h3>
                <form id="scanForm">
                    <div class="form-group">
                        <label for="hospitalName">åŒ»é™¢åç§° *</label>
                        <input type="text" id="hospitalName" name="hospitalName"
                               placeholder="è¯·è¾“å…¥åŒ»é™¢åç§°ï¼Œå¦‚ï¼šåŒ—äº¬åå’ŒåŒ»é™¢" required>
                    </div>
                    <div class="form-group">
                        <label for="query">æ‰«ææŸ¥è¯¢éœ€æ±‚</label>
                        <textarea id="query" name="query"
                                  placeholder="è¯·æè¿°éœ€è¦è·å–çš„ä¿¡æ¯ï¼Œå¦‚ï¼šè·å–åŒ»é™¢å±‚çº§ç»“æ„ã€ç§‘å®¤ä¿¡æ¯ã€åºŠä½æ•°ç­‰"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="scanBtn">
                        ğŸš€ å¼€å§‹æ‰«æ
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">
                        ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•
                    </button>
                </form>
            </div>

            <!-- å…¨é‡æ•°æ®åˆ·æ–° -->
            <div class="scan-form" style="border-left-color: #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                <h3>ğŸŒ å…¨é‡æ•°æ®åˆ·æ–°</h3>
                <p style="margin-bottom: 20px; color: #155724;">
                    <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>è·å–å…¨å›½æ‰€æœ‰çœä»½ã€åŸå¸‚ã€åŒºå¿çš„åŒ»é™¢æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡å¼‚æ­¥ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´å®Œæˆã€‚
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0;">
                        <label>å½“å‰æ•°æ®çŠ¶æ€</label>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>çœä»½æ•°é‡ï¼š</span>
                                <strong id="provinceCount">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>åŸå¸‚æ•°é‡ï¼š</span>
                                <strong id="cityCount">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>åŒºå¿æ•°é‡ï¼š</span>
                                <strong id="districtCount">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>åŒ»é™¢æ•°é‡ï¼š</span>
                                <strong id="hospitalCount">0</strong>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label>åˆ·æ–°é€‰é¡¹</label>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <div style="margin-bottom: 10px;">
                                <input type="radio" id="refreshAll" name="refreshType" value="all" checked>
                                <label for="refreshAll" style="margin-left: 8px; cursor: pointer;">
                                    ğŸŒ å…¨é‡åˆ·æ–°ï¼ˆæ¨èï¼‰
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="radio" id="refreshProvince" name="refreshType" value="province">
                                <label for="refreshProvince" style="margin-left: 8px; cursor: pointer;">
                                    ğŸ›ï¸ æŒ‡å®šçœä»½åˆ·æ–°
                                </label>
                            </div>
                            <div id="provinceSelect" style="display: none; margin-top: 10px;">
                                <select id="provinceDropdown" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">é€‰æ‹©çœä»½...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" id="refreshBtn" style="background: #28a745;">
                        ğŸ”„ å¼€å§‹æ•°æ®åˆ·æ–°
                    </button>
                    <button type="button" class="btn btn-secondary" id="refreshStatusBtn" style="background: #17a2b8;">
                        ğŸ“Š æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
                    </button>
                    <button type="button" class="btn btn-warning" id="clearDatabaseBtn" style="background: #ff6b6b; color: white;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“
                    </button>
                    <button type="button" class="btn btn-danger" id="clearTasksBtn" style="background: #dc3545; color: white;">
                        ğŸ§¹ åˆ é™¤æ‰€æœ‰ä»»åŠ¡
                    </button>
                    <button type="button" class="btn btn-secondary" id="refreshCancelBtn" style="background: #17a2b8; display: none;">
                        â¹ï¸ å–æ¶ˆåˆ·æ–°
                    </button>
                </div>

                <!-- çœä»½ä¸“ç”¨æ‰«ææŒ‰é’® -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                    <h4 style="color: #495057; margin-bottom: 15px;">ğŸ¯ çœä»½ä¸“ç”¨æ‰«æ</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" id="scanZhejiangBtn" style="background: #007bff; border-color: #007bff;">
                            ğŸ™ï¸ æ‰«ææµ™æ±Ÿçœå¸‚åŒº
                        </button>
                        <button type="button" class="btn btn-primary" id="scanBeijingBtn" style="background: #dc3545; border-color: #dc3545;">
                            ğŸ›ï¸ æ‰«æåŒ—äº¬å¸‚å¸‚åŒº
                        </button>
                    </div>
                    <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                        ğŸ’¡ å¿«é€Ÿæ‰«ææŒ‡å®šçœä»½çš„åŸå¸‚æ•°æ®ï¼Œæ— éœ€å¡«å†™è¡¨å•
                    </p>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="runningTasks">0</div>
                    <div class="stat-label">è¿è¡Œä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedTasks">0</div>
                    <div class="stat-label">å¤±è´¥</div>
                </div>
            </div>

            <!-- ä»»åŠ¡çŠ¶æ€ç›‘æ§ -->
            <div class="status-section">
                <h3>ğŸ“Š ä»»åŠ¡çŠ¶æ€ç›‘æ§</h3>
                <div id="taskList">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨æ‰«æ
                    </p>
                </div>
            </div>

            <!-- æ‰«æç»“æœå±•ç¤º -->
            <div class="result-section" id="resultSection">
                <h3>ğŸ“‹ æ‰«æç»“æœè¯¦æƒ…</h3>
                <div class="result-card">
                    <div class="result-header">
                        <h2 id="resultHospitalName">--</h2>
                        <p id="resultStatus">--</p>
                    </div>

                    <div class="hospital-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>åŒ»é™¢ç­‰çº§</strong>
                                <span id="hospitalLevel">--</span>
                            </div>
                            <div class="info-item">
                                <strong>åŒ»é™¢åœ°å€</strong>
                                <span id="hospitalAddress">--</span>
                            </div>
                            <div class="info-item">
                                <strong>è”ç³»ç”µè¯</strong>
                                <span id="hospitalPhone">--</span>
                            </div>
                            <div class="info-item">
                                <strong>åºŠä½æ•°</strong>
                                <span id="hospitalBeds">--</span>
                            </div>
                            <div class="info-item">
                                <strong>å‘˜å·¥æ€»æ•°</strong>
                                <span id="hospitalStaff">--</span>
                            </div>
                            <div class="info-item">
                                <strong>è¥ä¸šæ—¶é—´</strong>
                                <span id="hospitalHours">--</span>
                            </div>
                        </div>

                        <div class="departments-list">
                            <h4>ğŸ¥ ä¸´åºŠç§‘å®¤</h4>
                            <div class="tag-container" id="departmentsList">
                                <!-- åŠ¨æ€ç”Ÿæˆç§‘å®¤æ ‡ç­¾ -->
                            </div>
                        </div>

                        <div class="departments-list" style="margin-top: 20px;">
                            <h4>â­ ç‰¹è‰²ä¸“ç§‘</h4>
                            <div class="tag-container" id="specializationsList">
                                <!-- åŠ¨æ€ç”Ÿæˆä¸“ç§‘æ ‡ç­¾ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæ—¥å¿— -->
            <div class="log-section">
                <h4 style="margin-bottom: 15px;">ğŸ“ æ“ä½œæ—¥å¿—</h4>
                <div id="logContainer">
                    <div class="log-entry info">ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…æ‰«æä»»åŠ¡...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000';

        // ä»»åŠ¡ç®¡ç†
        let activeTasks = new Map();
        let pollingIntervals = new Map();

        // DOMå…ƒç´ 
        const scanForm = document.getElementById('scanForm');
        const scanBtn = document.getElementById('scanBtn');
        const clearBtn = document.getElementById('clearBtn');
        const taskList = document.getElementById('taskList');
        const resultSection = document.getElementById('resultSection');
        const logContainer = document.getElementById('logContainer');

        // æ•°æ®åˆ·æ–°ç›¸å…³å…ƒç´ 
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshStatusBtn = document.getElementById('refreshStatusBtn');
        const refreshCancelBtn = document.getElementById('refreshCancelBtn');
        const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
        const refreshAll = document.getElementById('refreshAll');
        const refreshProvince = document.getElementById('refreshProvince');
        const provinceSelect = document.getElementById('provinceSelect');
        const provinceDropdown = document.getElementById('provinceDropdown');

        // æ•°æ®åˆ·æ–°ä»»åŠ¡ç®¡ç†
        let refreshTaskId = null;
        let dataStats = {
            provinces: 0,
            cities: 0,
            districts: 0,
            hospitals: 0
        };

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // è¡¨å•æäº¤
        scanForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const hospitalName = document.getElementById('hospitalName').value.trim();
            const query = document.getElementById('query').value.trim();

            if (!hospitalName) {
                addLog('è¯·è¾“å…¥åŒ»é™¢åç§°', 'error');
                return;
            }

            try {
                // ç¦ç”¨æŒ‰é’®
                scanBtn.disabled = true;
                scanBtn.innerHTML = '<span class="loading"></span>å¯åŠ¨ä¸­...';

                addLog(`å¼€å§‹æ‰«æåŒ»é™¢: ${hospitalName}`, 'info');

                // å¯åŠ¨æ‰«æ
                const response = await fetch(`${API_BASE}/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        hospital_name: hospitalName,
                        query: query || 'è·å–åŒ»é™¢å±‚çº§ç»“æ„å’Œè¯¦ç»†ä¿¡æ¯'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const taskId = result.task_id || result.data?.task_id;
                    if (taskId) {
                        addLog(`æ‰«æä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${taskId}`, 'success');
                        startMonitoring(taskId, hospitalName);
                    } else {
                        throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');
                    }
                } else {
                    throw new Error(result.detail || 'å¯åŠ¨æ‰«æå¤±è´¥');
                }

            } catch (error) {
                addLog(`å¯åŠ¨æ‰«æå¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'ğŸš€ å¼€å§‹æ‰«æ';
            }
        });

        // æ¸…ç©ºè¡¨å•
        clearBtn.addEventListener('click', () => {
            scanForm.reset();
            addLog('è¡¨å•å·²æ¸…ç©º', 'info');
        });

        // åˆ·æ–°ç±»å‹åˆ‡æ¢
        refreshAll.addEventListener('change', () => {
            if (refreshAll.checked) {
                provinceSelect.style.display = 'none';
            }
        });

        refreshProvince.addEventListener('change', () => {
            if (refreshProvince.checked) {
                provinceSelect.style.display = 'block';
                loadProvinces();
            }
        });

        // åŠ è½½çœä»½æ•°æ®
        async function loadProvinces() {
            try {
                const response = await fetch(`${API_BASE}/provinces`);
                const data = await response.json();

                if (response.ok && data.items) {
                    provinceDropdown.innerHTML = '<option value="">é€‰æ‹©çœä»½...</option>';
                    data.items.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.name;
                        option.textContent = province.name;
                        provinceDropdown.appendChild(option);
                    });
                }
            } catch (error) {
                addLog(`åŠ è½½çœä»½æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ•°æ®åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        refreshBtn.addEventListener('click', async () => {
            try {
                // ç¦ç”¨æŒ‰é’®
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading"></span>å¯åŠ¨åˆ·æ–°...';

                let refreshType = document.querySelector('input[name="refreshType"]:checked').value;
                let url, taskName, logMsg;

                if (refreshType === 'all') {
                    url = `${API_BASE}/refresh/all`;
                    taskName = 'å®Œæ•´æ•°æ®åˆ·æ–°ä»»åŠ¡';
                    logMsg = 'å¯åŠ¨å…¨å›½åŒ»é™¢æ•°æ®åˆ·æ–°';
                } else {
                    const selectedProvince = provinceDropdown.value;
                    if (!selectedProvince) {
                        addLog('è¯·é€‰æ‹©è¦åˆ·æ–°çš„çœä»½', 'error');
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = 'ğŸ”„ å¼€å§‹æ•°æ®åˆ·æ–°';
                        return;
                    }
                    url = `${API_BASE}/refresh/province/${encodeURIComponent(selectedProvince)}`;
                    taskName = `çœä»½æ•°æ®åˆ·æ–°: ${selectedProvince}`;
                    logMsg = `å¯åŠ¨ ${selectedProvince} çš„åŒ»é™¢æ•°æ®åˆ·æ–°`;
                }

                addLog(logMsg, 'info');

                // å¯åŠ¨æ•°æ®åˆ·æ–°
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    refreshTaskId = result.task_id || result.data?.task_id;
                    if (refreshTaskId) {
                        addLog(`æ•°æ®åˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${refreshTaskId}`, 'success');
                        startMonitoring(refreshTaskId, taskName);

                        // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                        refreshCancelBtn.style.display = 'inline-block';
                    } else {
                        throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');
                    }
                } else {
                    throw new Error(result.detail || 'å¯åŠ¨æ•°æ®åˆ·æ–°å¤±è´¥');
                }

            } catch (error) {
                addLog(`å¯åŠ¨æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'ğŸ”„ å¼€å§‹æ•°æ®åˆ·æ–°';
            }
        });

        // æŸ¥çœ‹æ•°æ®ç»Ÿè®¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        refreshStatusBtn.addEventListener('click', async () => {
            try {
                refreshStatusBtn.disabled = true;
                refreshStatusBtn.innerHTML = '<span class="loading"></span>ç»Ÿè®¡ä¸­...';

                addLog('æ­£åœ¨è·å–æ•°æ®ç»Ÿè®¡ä¿¡æ¯...', 'info');

                // è·å–çœä»½æ•°æ®
                const provincesResponse = await fetch(`${API_BASE}/provinces`);
                const provincesData = await provincesResponse.json();

                if (provincesResponse.ok) {
                    dataStats.provinces = provincesData.total || provincesData.items?.length || 0;

                    // è®¡ç®—æ€»åŸå¸‚ã€åŒºå¿ã€åŒ»é™¢æ•°é‡
                    let totalCities = 0;
                    let totalDistricts = 0;
                    let totalHospitals = 0;

                    if (provincesData.items) {
                        for (const province of provincesData.items) {
                            totalCities += province.cities_count || 0;
                            totalDistricts += province.districts_count || 0;
                            totalHospitals += province.hospitals_count || 0;
                        }
                    }

                    dataStats.cities = totalCities;
                    dataStats.districts = totalDistricts;
                    dataStats.hospitals = totalHospitals;

                    // æ›´æ–°æ˜¾ç¤º
                    updateDataStats();

                    addLog(`æ•°æ®ç»Ÿè®¡å®Œæˆ: ${dataStats.provinces}çœä»½, ${dataStats.cities}åŸå¸‚, ${dataStats.districts}åŒºå¿, ${dataStats.hospitals}åŒ»é™¢`, 'success');
                } else {
                    throw new Error('è·å–æ•°æ®ç»Ÿè®¡å¤±è´¥');
                }

            } catch (error) {
                addLog(`è·å–æ•°æ®ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            } finally {
                refreshStatusBtn.disabled = false;
                refreshStatusBtn.innerHTML = 'ğŸ“Š æŸ¥çœ‹æ•°æ®ç»Ÿè®¡';
            }
        });

        // å–æ¶ˆåˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        refreshCancelBtn.addEventListener('click', () => {
            if (refreshTaskId) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ å–æ¶ˆä»»åŠ¡çš„é€»è¾‘
                addLog('å–æ¶ˆæ•°æ®åˆ·æ–°ä»»åŠ¡åŠŸèƒ½å¾…å®ç°', 'info');
                refreshCancelBtn.style.display = 'none';
                refreshTaskId = null;
            }
        });

        // æ¸…ç©ºæ•°æ®åº“æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clearDatabaseBtn.addEventListener('click', async () => {
            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„æ•°æ®ï¼ˆåŒ…æ‹¬ä»»åŠ¡è®°å½•ã€çœä»½ã€åŸå¸‚ã€åŒºå¿ã€åŒ»é™¢ä¿¡æ¯ç­‰ï¼‰ï¼Œä½†ä¼šä¿ç•™è¡¨ç»“æ„ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');

            if (!confirmed) {
                return;
            }

            try {
                // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                clearDatabaseBtn.disabled = true;
                clearDatabaseBtn.innerHTML = 'ğŸ”„ æ¸…ç©ºä¸­...';

                addLog('å¼€å§‹æ¸…ç©ºæ•°æ®åº“...', 'info');

                // è°ƒç”¨æ¸…ç©ºæ•°æ®åº“API
                const response = await fetch(`${API_BASE}/database/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    addLog(`æ•°æ®åº“æ¸…ç©ºæˆåŠŸï¼${result.message}`, 'success');

                    // é‡ç½®æ•°æ®ç»Ÿè®¡
                    dataStats = {
                        provinces: 0,
                        cities: 0,
                        districts: 0,
                        hospitals: 0
                    };
                    updateDataStats();

                    // æ¸…ç©ºæ´»è·ƒä»»åŠ¡
                    activeTasks.clear();
                    pollingIntervals.forEach(interval => clearInterval(interval));
                    pollingIntervals.clear();

                    // é‡æ–°åŠ è½½æ•°æ®ç»Ÿè®¡
                    await loadStatistics();

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®åº“å¤±è´¥:', error);
                addLog(`æ¸…ç©ºæ•°æ®åº“å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                clearDatabaseBtn.disabled = false;
                clearDatabaseBtn.innerHTML = 'ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“';
            }
        });

        // åˆ é™¤æ‰€æœ‰ä»»åŠ¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clearTasksBtn.addEventListener('click', async () => {
            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ•°æ®åº“ä¸­æ‰€æœ‰çš„ä»»åŠ¡è®°å½•ï¼ˆåŒ…æ‹¬ä»»åŠ¡å†å²ã€çŠ¶æ€ã€ç»“æœç­‰ï¼‰ã€‚\n\næ³¨æ„ï¼šæ­¤æ“ä½œä¸ä¼šåˆ é™¤çœä»½ã€åŸå¸‚ã€åŒºå¿ã€åŒ»é™¢ç­‰åŸºç¡€æ•°æ®ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');

            if (!confirmed) {
                return;
            }

            try {
                // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                clearTasksBtn.disabled = true;
                clearTasksBtn.innerHTML = 'ğŸ”„ åˆ é™¤ä¸­...';

                addLog('å¼€å§‹åˆ é™¤æ‰€æœ‰ä»»åŠ¡è®°å½•...', 'info');

                // è°ƒç”¨åˆ é™¤æ‰€æœ‰ä»»åŠ¡API
                const response = await fetch(`${API_BASE}/tasks/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    addLog(`æ‰€æœ‰ä»»åŠ¡è®°å½•åˆ é™¤æˆåŠŸ: ${result.message}`, 'success');

                    // æ¸…ç©ºä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
                    currentTasks = [];
                    updateTaskList();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`âœ… ${result.message}\n\nåˆ é™¤æ—¶é—´: ${new Date(result.data.cleared_at).toLocaleString()}`);

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('åˆ é™¤æ‰€æœ‰ä»»åŠ¡å¤±è´¥:', error);
                addLog(`åˆ é™¤æ‰€æœ‰ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
                alert(`âŒ åˆ é™¤æ‰€æœ‰ä»»åŠ¡å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                clearTasksBtn.disabled = false;
                clearTasksBtn.innerHTML = 'ğŸ§¹ åˆ é™¤æ‰€æœ‰ä»»åŠ¡';
            }
        });

        // æµ™æ±Ÿçœæ‰«ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('scanZhejiangBtn').addEventListener('click', async () => {
            await scanProvince('æµ™æ±Ÿçœ', 'scanZhejiangBtn');
        });

        // åŒ—äº¬å¸‚æ‰«ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('scanBeijingBtn').addEventListener('click', async () => {
            await scanProvince('åŒ—äº¬å¸‚', 'scanBeijingBtn');
        });

        // çœä»½æ‰«æé€šç”¨å‡½æ•°
        async function scanProvince(provinceName, buttonId) {
            const button = document.getElementById(buttonId);

            try {
                // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span>æ­£åœ¨æ‰«æ...';

                addLog(`ğŸš€ å¼€å§‹æ‰«æ${provinceName}çš„å¸‚åŒºæ•°æ®...`, 'info');

                // è°ƒç”¨çœä»½åˆ·æ–°API
                const response = await fetch(`${API_BASE}/refresh/province/${encodeURIComponent(provinceName)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    const taskId = result.data.task_id;
                    addLog(`âœ… ${provinceName}æ‰«æä»»åŠ¡å·²åˆ›å»º`, 'success');
                    addLog(`ğŸ“‹ ä»»åŠ¡ID: ${taskId}`, 'info');
                    addLog(`â° åˆ›å»ºæ—¶é—´: ${new Date(result.data.created_at).toLocaleString()}`, 'info');

                    // å¼€å§‹ç›‘æ§ä»»åŠ¡è¿›åº¦
                    startMonitoring(taskId, `${provinceName}å¸‚åŒºæ‰«æ`);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`âœ… ${provinceName}æ‰«æä»»åŠ¡å·²å¯åŠ¨ï¼\n\nä»»åŠ¡ID: ${taskId}\nåˆ›å»ºæ—¶é—´: ${new Date(result.data.created_at).toLocaleString()}\n\nè¯·ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ›´æ–°è¿›åº¦ã€‚`);

                } else {
                    const errorData = result;
                    throw new Error(errorData.message || errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error(`${provinceName}æ‰«æå¤±è´¥:`, error);
                addLog(`${provinceName}æ‰«æå¤±è´¥: ${error.message}`, 'error');
                alert(`âŒ ${provinceName}æ‰«æå¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                button.innerHTML = provinceName === 'æµ™æ±Ÿçœ' ? 'ğŸ™ï¸ æ‰«ææµ™æ±Ÿçœå¸‚åŒº' : 'ğŸ›ï¸ æ‰«æåŒ—äº¬å¸‚å¸‚åŒº';
            }
        }

        // æ›´æ–°æ•°æ®ç»Ÿè®¡æ˜¾ç¤º
        function updateDataStats() {
            document.getElementById('provinceCount').textContent = dataStats.provinces;
            document.getElementById('cityCount').textContent = dataStats.cities;
            document.getElementById('districtCount').textContent = dataStats.districts;
            document.getElementById('hospitalCount').textContent = dataStats.hospitals;
        }

        // å¼€å§‹ç›‘æ§ä»»åŠ¡
        function startMonitoring(taskId, hospitalName) {
            const taskData = {
                id: taskId,
                hospitalName: hospitalName,
                status: 'pending',
                createdAt: new Date(),
                result: null,
                error: null
            };

            activeTasks.set(taskId, taskData);
            updateTaskList();
            updateStats();

            // å¼€å§‹è½®è¯¢
            const interval = setInterval(() => {
                checkTaskStatus(taskId);
            }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡

            pollingIntervals.set(taskId, interval);
        }

        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        async function checkTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE}/task/${taskId}`);
                const task = await response.json();

                if (response.ok) {
                    updateTaskData(taskId, task);

                    // å¦‚æœä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                    if (task.status === 'completed' || task.status === 'failed') {
                        const interval = pollingIntervals.get(taskId);
                        if (interval) {
                            clearInterval(interval);
                            pollingIntervals.delete(taskId);
                        }

                        // æ˜¾ç¤ºç»“æœ
                        if (task.status === 'completed') {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®åˆ·æ–°ä»»åŠ¡
                            if (task.hospital_name && task.hospital_name.includes('åˆ·æ–°')) {
                                addLog(`æ•°æ®åˆ·æ–°å®Œæˆ: ${task.hospital_name}`, 'success');
                                // åˆ·æ–°æ•°æ®ç»Ÿè®¡
                                await loadInitialDataStats();

                                // éšè—å–æ¶ˆæŒ‰é’®
                                refreshCancelBtn.style.display = 'none';
                                refreshTaskId = null;
                            } else {
                                displayResult(task);
                                addLog(`æ‰«æå®Œæˆ: ${task.hospital_name || 'æœªçŸ¥åŒ»é™¢'}`, 'success');
                            }
                        } else {
                            addLog(`æ‰«æå¤±è´¥: ${task.error_message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        }
                    }
                } else {
                    addLog(`è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${response.status}`, 'error');
                }

            } catch (error) {
                addLog(`æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å‡ºé”™: ${error.message}`, 'error');
            }

            updateTaskList();
            updateStats();
        }

        // æ›´æ–°ä»»åŠ¡æ•°æ®
        function updateTaskData(taskId, taskData) {
            const existingTask = activeTasks.get(taskId);
            if (existingTask) {
                existingTask.status = taskData.status || 'unknown';
                existingTask.result = taskData.result;
                existingTask.error = taskData.error_message;
                existingTask.updatedAt = new Date();
            }
        }

        // æ›´æ–°ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        function updateTaskList() {
            if (activeTasks.size === 0) {
                taskList.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 40px;">
                        æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨æ‰«æ
                    </p>
                `;
                return;
            }

            const tasksHtml = Array.from(activeTasks.values()).map(task => {
                const statusClass = task.status;
                const statusText = getStatusText(task.status);
                const progress = getProgress(task.status);

                return `
                    <div class="status-card ${statusClass}">
                        <div class="status-header">
                            <div>
                                <strong>${task.hospitalName}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ID: ${task.id.substring(0, 8)}... |
                                    åˆ›å»º: ${formatTime(task.createdAt)}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>

                        ${task.status === 'running' ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}

                        ${task.error ? `
                            <div class="error-message">
                                é”™è¯¯: ${task.error}
                            </div>
                        ` : ''}

                        ${task.result ? `
                            <div style="color: #28a745; font-size: 14px;">
                                âœ… æ‰«æå·²å®Œæˆï¼Œç‚¹å‡»ä¸‹æ–¹æŸ¥çœ‹ç»“æœ
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            taskList.innerHTML = tasksHtml;
        }

        // æ˜¾ç¤ºæ‰«æç»“æœ
        function displayResult(task) {
            try {
                let resultData;
                if (typeof task.result === 'string') {
                    resultData = JSON.parse(task.result);
                } else {
                    resultData = task.result;
                }

                const hospitalInfo = resultData.hospital_info || {};

                // å¡«å……åŸºæœ¬ä¿¡æ¯
                document.getElementById('resultHospitalName').textContent = hospitalInfo.hospital_name || 'æœªçŸ¥åŒ»é™¢';
                document.getElementById('resultStatus').textContent = `æ‰«æçŠ¶æ€: ${getStatusText(task.status)}`;

                document.getElementById('hospitalLevel').textContent = hospitalInfo.level || 'æœªçŸ¥';
                document.getElementById('hospitalAddress').textContent = hospitalInfo.address || 'æœªçŸ¥';
                document.getElementById('hospitalPhone').textContent = hospitalInfo.phone || 'æœªçŸ¥';
                document.getElementById('hospitalBeds').textContent = hospitalInfo.beds_count || 'æœªçŸ¥';
                document.getElementById('hospitalStaff').textContent = hospitalInfo.staff_count || 'æœªçŸ¥';
                document.getElementById('hospitalHours').textContent = hospitalInfo.operating_hours || 'æœªçŸ¥';

                // å¡«å……ç§‘å®¤åˆ—è¡¨
                const departmentsList = document.getElementById('departmentsList');
                if (hospitalInfo.departments && Array.isArray(hospitalInfo.departments)) {
                    departmentsList.innerHTML = hospitalInfo.departments
                        .map(dept => `<span class="tag">${dept}</span>`)
                        .join('');
                } else {
                    departmentsList.innerHTML = '<span style="color: #666;">æš‚æ— ç§‘å®¤ä¿¡æ¯</span>';
                }

                // å¡«å……ç‰¹è‰²ä¸“ç§‘
                const specializationsList = document.getElementById('specializationsList');
                if (hospitalInfo.specializations && Array.isArray(hospitalInfo.specializations)) {
                    specializationsList.innerHTML = hospitalInfo.specializations
                        .map(spec => `<span class="tag specialization">${spec}</span>`)
                        .join('');
                } else {
                    specializationsList.innerHTML = '<span style="color: #666;">æš‚æ— ç‰¹è‰²ä¸“ç§‘ä¿¡æ¯</span>';
                }

                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                resultSection.classList.add('show');

                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                resultSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                addLog(`è§£ææ‰«æç»“æœå¤±è´¥: ${error.message}`, 'error');
                resultSection.classList.add('show');
                document.getElementById('resultHospitalName').textContent = 'ç»“æœè§£æå¤±è´¥';
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const tasks = Array.from(activeTasks.values());
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const running = tasks.filter(t => t.status === 'running').length;
            const failed = tasks.filter(t => t.status === 'failed').length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('runningTasks').textContent = running;
            document.getElementById('failedTasks').textContent = failed;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // è·å–è¿›åº¦ç™¾åˆ†æ¯”
        function getProgress(status) {
            const progressMap = {
                'pending': 0,
                'running': 50,
                'completed': 100,
                'failed': 0,
                'cancelled': 0
            };
            return progressMap[status] || 0;
        }

        // åŠ è½½åˆå§‹æ•°æ®ç»Ÿè®¡
        async function loadInitialDataStats() {
            try {
                const provincesResponse = await fetch(`${API_BASE}/provinces`);
                const provincesData = await provincesResponse.json();

                if (provincesResponse.ok) {
                    dataStats.provinces = provincesData.total || provincesData.items?.length || 0;

                    // è®¡ç®—æ€»åŸå¸‚ã€åŒºå¿ã€åŒ»é™¢æ•°é‡
                    let totalCities = 0;
                    let totalDistricts = 0;
                    let totalHospitals = 0;

                    if (provincesData.items) {
                        for (const province of provincesData.items) {
                            totalCities += province.cities_count || 0;
                            totalDistricts += province.districts_count || 0;
                            totalHospitals += province.hospitals_count || 0;
                        }
                    }

                    dataStats.cities = totalCities;
                    dataStats.districts = totalDistricts;
                    dataStats.hospitals = totalHospitals;

                    // æ›´æ–°æ˜¾ç¤º
                    updateDataStats();

                    addLog(`åˆå§‹æ•°æ®ç»Ÿè®¡: ${dataStats.provinces}çœä»½, ${dataStats.cities}åŸå¸‚, ${dataStats.districts}åŒºå¿, ${dataStats.hospitals}åŒ»é™¢`, 'info');
                }
            } catch (error) {
                addLog(`åŠ è½½åˆå§‹æ•°æ®ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return new Date(date).toLocaleTimeString();
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç°æœ‰ä»»åŠ¡å’Œæ•°æ®ç»Ÿè®¡
        window.addEventListener('load', async () => {
            try {
                addLog('æ­£åœ¨åŠ è½½ç³»ç»Ÿä¿¡æ¯...', 'info');

                // è·å–æ•°æ®ç»Ÿè®¡
                await loadInitialDataStats();

                // è·å–ç°æœ‰ä»»åŠ¡
                const response = await fetch(`${API_BASE}/tasks`);
                const tasks = await response.json();

                if (Array.isArray(tasks)) {
                    tasks.forEach(task => {
                        if (task.status === 'running' || task.status === 'pending') {
                            startMonitoring(task.task_id, task.hospital_name || 'æœªçŸ¥åŒ»é™¢');
                        } else {
                            // æ˜¾ç¤ºå·²å®Œæˆçš„ä»»åŠ¡ä½†ä¸ç›‘æ§
                            const taskData = {
                                id: task.task_id,
                                hospitalName: task.hospital_name || 'æœªçŸ¥åŒ»é™¢',
                                status: task.status,
                                createdAt: task.created_at,
                                result: task.result,
                                error: task.error_message
                            };
                            activeTasks.set(task.task_id, taskData);
                        }
                    });

                    updateTaskList();
                    updateStats();
                    addLog(`åŠ è½½äº† ${tasks.length} ä¸ªç°æœ‰ä»»åŠ¡`, 'success');
                }

            } catch (error) {
                addLog(`åŠ è½½ç°æœ‰ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            pollingIntervals.forEach(interval => clearInterval(interval));
        });
    </script>
</body>
</html>